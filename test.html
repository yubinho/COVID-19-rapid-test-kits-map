<!DOCTYPE html>

<html>
    <head>
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css" integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA==" crossorigin=""/>
        <style>
            html, body{
                width: 100%;
                height: 100%;
            }
            #map{
                width: 100%;
                height: 90%;
            }
        </style>
    </head>
    <body>
        <div id="map"></div>
        <div id="item">
            <label style="font-weight:bold;">選擇地區：</label>
            <select id="county" name="county" style="cursor:pointer;"  onchange="Select()">
                <option value="高雄市" selected="selected">高雄市</option>
                <option value="台南市" >台南市</option>
                <option value="屏東市" >屏東市</option>
                <option value="屏東縣">屏東縣</option>
                <option value="嘉義市">嘉義市</option>
        </select>
        
        </div>           
        <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js" integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA==" crossorigin=""></script>
        <script>
            var map;
            function NewMap(){
                // create Leaflet map and set coordinate
                map = L.map('map').setView([22.7211, 120.3007], 14);
                
                //set graphics source 
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '<a href="https://www.openstreetmap.org/">OSM</a>',
                    maxZoom: 18,
                }).addTo(map);
            }
            function Select(){
                var selected = document.getElementById("county").value;
                //map.off()
                Search(selected)
            }
            function Search(condition){
                console.log(condition)
                // let container = L.DomUtil.get('map');
                // if(container != null){
                //     container._leaflet_id = null;
                // }   
                // map.invalidateSize();  

                const req = new Request('https://data.nhi.gov.tw/Datasets/Download.ashx?rid=A21030000I-D03001-001&l=https://data.nhi.gov.tw/resource/Nhi_Fst/Fstdata.csv')
                fetch(req)
                .then(function(response){
                    return response.text();
                })
                .then(function(data){
                    //console.log(data)
                    var rows = data.split("\n")
                    //var rows = data.split(/\r?\n/);
                    for(let i=1;i<rows.length;i++){
                        let cols = rows[i].split(",");
                        let name = cols[2];
                        let longitude = cols[3];
                        let latitude = cols[4];
                        let category = cols[6];
                        let quantity = cols[7];
                        let content = ("藥局名稱:"+name+'<br\>'+"廠牌:"+category+" 數量:"+quantity+'<br\>'+"備註:"+cols[9]);
                        //console.log(rows[i])
                        if(name != undefined){
                            if(name.startsWith(condition)){
                                var marker = L.marker([latitude, longitude]);
                                marker.bindPopup(content)
                                marker.addTo(map);
                            }
                            //console.log(content);
                        }
                    }
                })
            }
            NewMap();
            Select();
            


        </script>
    </body>
</html>